<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style_template.css') }}">

    <title>Template Creator</title>
</head>
<body>
    <!-- Navbar -->
    <nav style="background: linear-gradient(to right, #0f2d36, #174958, #174958); padding: 15px 40px; display: flex; justify-content: space-between; align-items: center; color: white;">
    <!-- Left Side -->
    <!-- Back to Main Page (left-aligned inside flex) -->
    <div style="font-size: 20px; font-weight: bold;">
        <a href="{{ url_for('index') }}" 
            style=" left: 20px; text-decoration: none;  font-weight: bold; font-size: 15px;color: white;">
            Back to Home
        </a>
    </div>

    <!-- Right Side Dropdown -->
     <div style="position: relative;">
            <span onclick="toggleDropdown()" style="cursor: pointer; font-size: 15px;">Sign Out</span>
            <div id="dropdownMenu" style="display: none; position: absolute; right: 0; background: white; color: black; border-radius: 15px; box-shadow: 0 14px 16px rgba(0,0,0,0.1); margin-top: 8px; min-width: 220px; text-align: left; z-index: 100;">
            <a href="/logout" style="display: block; padding: 10px; text-decoration: none; color: black;">ðŸš« Sign Out</a>
            </div>
        </div>
    </nav>
<div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 20px; margin-top: 20px;">    
    <!-- Centered Title -->
    <h1>Template Creator</h1>
</div>

    <div class="container">
        <div class="editor-panel">
            <label><strong>Template Name</strong></label>
            <input type="text" id="templateName" placeholder="Enter template name (e.g., my-template)" />
            <label><strong>Template Content</strong></label>
            <textarea id="templateContent" placeholder="Enter your HTML template content here..."><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title | default('My Template') }}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>{{ heading | default('Welcome') }}</h1>
        <p>{{ content | default('This is a sample template content.') }}</p>
    </div>

</body>
</html></textarea>

            <div>
                <div style="display: flex; justify-content: space-between; gap: 10px;">
                    <button id="createTemplateBtn" onclick="createTemplate()" class="template-button">Create Template</button>
                    <button onclick="previewTemplate()" class="template-button">Preview</button>
                    
                </div>
            </div>
            
            <div id="status"></div>
        </div>
        
        <div class="preview-panel">
            <h3>Preview</h3>
            <iframe id="previewFrame" style="width: 100%; height: 400px; border: 1px solid #ccc;"></iframe>
        </div>
    </div>

    <!-- <div class="template-list">
        <h3>Existing Templates</h3>
        <div id="templatesList">Click "List Templates" to see existing templates</div>
    </div> -->
        <!-- Templates Section -->
        <div style="max-width: 1200px;margin: 0 auto; padding: 20px;">
            <h3 id="templatesHeading" style="display:none; margin-top:30px;">Available Templates</h3>
            <table class="table table-bordered table-hover text-center" id="templatesTable" style="display:none;">
                <thead class="table-dark">
                    <tr>
                        <th>Sr No</th>
                        <th>Template Name</th>
                        <th>Preview</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="templatesList"></tbody>
            </table>
        </div>

    <script>
        async function createTemplate() {
            const templateName = document.getElementById('templateName').value.trim();
            const templateContent = document.getElementById('templateContent').value.trim();
            const statusDiv = document.getElementById('status');
            const createBtn = document.getElementById('createTemplateBtn');
            
            // Validation
            if (!templateName) {
                showStatus('Please enter a template name', 'error');
                return;
            }
            
            if (!templateContent) {
                showStatus('Please enter template content', 'error');
                return;
            }
            
            // Disable button during request
            createBtn.disabled = true;
            createBtn.textContent = 'Creating...';
            
            try {
                const response = await fetch('/create-template', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: templateName,
                        content: templateContent
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus(result.message, 'success');
                    // Clear form
                    document.getElementById('templateName').value = '';
                    // Refresh template list
                    loadTemplates();
                } else {
                    showStatus(result.message, 'error');
                }
                
            } catch (error) {
                showStatus('Error creating template: ' + error.message, 'error');
            } finally {
                // Re-enable button
                createBtn.disabled = false;
                createBtn.textContent = 'Create Template';
            }
        }
        
        
        function previewTemplate() {
            const content = document.getElementById('templateContent').value;
            const previewFrame = document.getElementById('previewFrame');
            
            // Create a blob URL for preview
            const blob = new Blob([content], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            previewFrame.src = url;
        }
        
        async function loadTemplates() {
            try {
                const response = await fetch('/list-templates');
                const result = await response.json();
                
                const templatesDiv = document.getElementById('templatesList');
                
                if (result.success && result.templates.length > 0) {
                    const templateList = result.templates.map(template => 
                        `<div style="margin: 5px 0;">
                            <span>${template}</span>
                            <button onclick="previewExistingTemplate('${template}')" style="margin-left: 10px; padding: 5px 10px; font-size: 12px;">Preview</button>
                        </div>`
                    ).join('');
                    templatesDiv.innerHTML = templateList;
                } else {
                    templatesDiv.innerHTML = 'No templates found';
                }
                
            } catch (error) {
                document.getElementById('templatesList').innerHTML = 'Error loading templates';
            }
        }
        
        function previewExistingTemplate(templateName) {
            const previewFrame = document.getElementById('previewFrame');
            previewFrame.src = `/${templateName}`;
        }
        
        // Load templates on page load
        window.onload = function() {
            loadTemplates();
        }
    </script>
    <script>
        // Refresh templates if another tab signals it
        window.addEventListener("storage", function (event) {
            if (event.key === "refreshTemplates") {
                loadTemplates();
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    async function createTemplate() {
        const templateName = document.getElementById('templateName').value.trim();
        const templateContent = document.getElementById('templateContent').value.trim();
        const createBtn = document.getElementById('createTemplateBtn');
        
        // Validation
        if (!templateName) {
            showToast('Please enter a template name', 'error');
            return;
        }
        
        if (!templateContent) {
            showToast('Please enter template content', 'error');
            return;
        }
        
        // Disable button during request
        createBtn.disabled = true;
        createBtn.textContent = 'Creating...';
        
        try {
            const response = await fetch('/create-template', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: templateName,
                    content: templateContent
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast(result.message, 'success');
                // Clear form
                document.getElementById('templateName').value = '';
                // Refresh template list
                loadTemplates();
                // Notify other tabs to refresh
                localStorage.setItem("refreshTemplates", Date.now());
            } else {
                showToast(result.message, 'error');
            }
            
        } catch (error) {
            showToast('Error creating template: ' + error.message, 'error');
        } finally {
            // Re-enable button
            createBtn.disabled = false;
            createBtn.textContent = 'Create Template';
        }
    }
    
    function showToast(message, icon) {
        Swal.fire({
            toast: true,
            position: 'top-end',
            icon: icon, // "success" or "error"
            title: message,
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true
        });
    }
</script>

<script>
    function loadTemplates() {
        fetch("/list-templates")
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const tbody = document.getElementById("templatesList");
                    tbody.innerHTML = ""; // clear old data

                    data.templates.forEach((template, index) => {
                        const row = `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${template}</td>
                                <td>
                                    <a href="/static/templates/${template}" target="_blank" class="btn btn-sm btn-info">
                                        Preview
                                    </a>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-danger" onclick="deleteTemplate('${template}')">
                                        Delete
                                    </button>
                                </td>
                            </tr>
                        `;
                        tbody.insertAdjacentHTML("beforeend", row);
                    });

                    // show table & heading if templates exist
                    document.getElementById("templatesHeading").style.display = data.templates.length > 0 ? "block" : "none";
                    document.getElementById("templatesTable").style.display = data.templates.length > 0 ? "table" : "none";
                }
            })
            .catch(err => console.error("Error loading templates:", err));
    }

     function deleteTemplate(templateName) {
        Swal.fire({
            title: `Delete ${templateName}?`,
            text: "This action cannot be undone!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d33",
            cancelButtonColor: "#3085d6",
            confirmButtonText: "Yes, delete it!"
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/delete-template/${templateName}`, { method: "DELETE" })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            loadTemplates(); // refresh table
                            showToast("Template deleted successfully!", "success");
                        } else {
                            showToast("Error: " + data.message, "error");
                        }
                    })
                    .catch(err => {
                        console.error("Error deleting template:", err);
                        showToast("Error deleting template", "error");
                    });
            }
        });
    }

    function showToast(message, icon) {
        Swal.fire({
            toast: true,
            position: 'top-end',
            icon: icon,
            title: message,
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true
        });
    }

    // Load templates on page load
    document.addEventListener("DOMContentLoaded", loadTemplates);
</script>
<script>
    function toggleDropdown() {
        const dropdown = document.getElementById("dropdownMenu");
        dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
    }

    // Close dropdown when clicking outside
    document.addEventListener("click", function (e) {
        const dropdown = document.getElementById("dropdownMenu");
        if (!e.target.closest("nav")) {
        dropdown.style.display = "none";
        }
    });
</script>
<!-- Footer -->
    <footer style="background: linear-gradient(to right, #0f2d36, #174958, #174958); color: white; padding: 20px 40px; text-align: center; margin-top: 40px;">
    <p style="margin: 0; font-size: 20px;"><b>
        &copy; 2025 MailFusion. All rights reserved.
    </b></p>
    <!-- <p style="margin: 5px 0 0; font-size: 13px;">
        <a href="/privacy" style="color: #fca765; text-decoration: none; margin: 0 10px;">Privacy Policy</a> | 
        <a href="/terms" style="color: #fca765; text-decoration: none; margin: 0 10px;">Terms of Service</a> | 
        <a href="/contact" style="color: #fca765; text-decoration: none; margin: 0 10px;">Contact</a>
    </p> -->
    </footer>
</body>
</html>