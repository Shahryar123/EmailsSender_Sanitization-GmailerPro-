<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css" rel="stylesheet">
    <!-- SweetAlert2 -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style_admin.css') }}">
</head>
<body>
    <nav style="background: linear-gradient(to right, #0f2d36, #174958, #174958); padding: 15px 40px; display: flex; justify-content: flex-end; align-items: center; color: white;">
        <div style="position: relative;">
            <span onclick="toggleDropdown()" style="cursor: pointer; font-size: 25px;">â›”</span>
            <div id="dropdownMenu" style="display: none; position: absolute; right: 0; background: white; color: black; border-radius: 15px; box-shadow: 0 14px 16px rgba(0,0,0,0.1); margin-top: 8px; min-width: 220px; text-align: left; z-index: 100;">
                <a href="/logout" style="display: block; padding: 10px; text-decoration: none; color: black;">ðŸš« Sign Out</a>
            </div>
        </div>
    </nav>


    <div class="main-container">
        <!-- Header -->
        <div class="header">
            <h1><i class="bi bi-toggles"></i> Admin Dashboard</h1>
            <p>Control feature access with simple toggle switches</p>
        </div>

        <!-- Feature Table -->
        <div class="table-card">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="featureTable">
                    <thead>
                        <tr>
                            <th scope="col" class="feature-header">
                                <i class="bi bi-person"></i><br>App Service
                            </th>
                            <th scope="col" class="feature-header">
                                <i class="bi bi-graph-up"></i><br>Generate CSV
                            </th>
                            <th scope="col" class="feature-header">
                                <i class="bi bi-file-earmark-text"></i><br>Send Email
                            </th>
                            <th scope="col" class="feature-header">
                                <i class="bi bi-cloud-arrow-up"></i><br>Email Insights
                            </th>
                            <th scope="col" class="feature-header">
                                <i class="bi bi-lightning"></i><br>Send Whatsapp 
                            </th>
                            <th scope="col" class="text-center">
                                <i class="bi bi-gear"></i><br> Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Dynamic content -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>   
    <script>
        let users = [];
        const featureNames = ['Generate CSV', 'Send Email', 'Email Insights', 'Send Whatsapp'];

        function generateTableRow(user, index) {
            return `
                <tr>
                    <td class="email-cell">${user.email}</td>
                    ${user.features.map((isEnabled, featureIndex) => `
                        <td class="text-center">
                            <div class="toggle-container">
                                <label class="toggle-switch">
                                    <input type="checkbox" 
                                           id="user${index}_feature${featureIndex}" 
                                           ${isEnabled ? 'checked' : ''}
                                           onchange="updateToggleStatus(${index}, ${featureIndex})">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span class="toggle-status ${isEnabled ? 'status-enabled' : 'status-disabled'}" 
                                      id="status_${index}_${featureIndex}">
                                    ${isEnabled ? 'Enabled' : 'Disabled'}
                                </span>
                            </div>
                        </td>
                    `).join('')}
                    <td class="text-center">
                        <button class="btn btn-update" onclick="submitUserSettings(${index})">
                            <i class="bi bi-check-lg"></i> Update
                        </button>
                    </td>
                </tr>
            `;
        }

        function updateToggleStatus(userIndex, featureIndex) {
            const checkbox = document.getElementById(`user${userIndex}_feature${featureIndex}`);
            const statusSpan = document.getElementById(`status_${userIndex}_${featureIndex}`);
            
            if (checkbox.checked) {
                statusSpan.textContent = 'Enabled';
                statusSpan.className = 'toggle-status status-enabled';
            } else {
                statusSpan.textContent = 'Disabled';
                statusSpan.className = 'toggle-status status-disabled';
            }
        }

        function renderTable() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = users.map((user, index) => generateTableRow(user, index)).join('');
        }

        async function submitUserSettings(userIndex) {
            const user = users[userIndex];
            const updatedFeatures = {};

            // Collect current toggle states
            for (let featureIndex = 0; featureIndex < 4; featureIndex++) {
                const checkbox = document.getElementById(`user${userIndex}_feature${featureIndex}`);
                const flagName = ["GENERATE-CSV", "SEND-EMAIL", "EMAIL-INSIGHT", "SEND-MSG"][featureIndex];
                updatedFeatures[flagName] = checkbox.checked;
            }

            // Show SweetAlert loading
            Swal.fire({
                title: "Adding Permissions",
                text: "Please wait...",
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                const response = await fetch("/api/update-flags", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        app_name: user.email,
                        features: updatedFeatures
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    Swal.fire({
                        icon: "success",
                        title: "Permissions Granted",
                        text: `Settings updated for ${user.email}`,
                        timer: 2000,
                        showConfirmButton: false
                    });
                    console.log("Updated Key Vault:", result);
                } else {
                    Swal.fire({
                        icon: "error",
                        title: "Update Failed",
                        text: result.error || `Error updating ${user.email}`
                    });
                    console.error("Update error:", result);
                }
            } catch (err) {
                Swal.fire({
                    icon: "error",
                    title: "Request Failed",
                    text: `Could not update ${user.email}`
                });
                console.error(err);
            }
        }

        async function loadAppServices() {
        const tableBody = document.getElementById('tableBody');
        tableBody.innerHTML = `<tr>
            <td colspan="6" class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Fetching app services...</p>
            </td>
        </tr>`;

        try {
            const response = await fetch("/api/app-services");
            const data = await response.json();

            // log backend messages if present
            if (data.logs) {
                data.logs.forEach(msg => console.log("[Backend]", msg));
            }

            // pick services array
            const services = data.services || [];

            users = services.map(app => ({
                email: app.app_name,
                features: [
                    app.features["GENERATE-CSV"] || false,
                    app.features["SEND-EMAIL"] || false,
                    app.features["EMAIL-INSIGHT"] || false,
                    app.features["SEND-MSG"] || false
                ]
            }));

            renderTable();
        } catch (error) {
            console.error("Error fetching app services:", error);
            const tableBody = document.getElementById("tableBody");
            tableBody.innerHTML = `<tr>
                <td colspan="6" class="text-center text-danger">
                    Failed to load app services.
                </td>
            </tr>`;
        }

    }

        // Initialize table on load
        document.addEventListener('DOMContentLoaded', function() {
            loadAppServices();
        });
    </script>
    
<!-- LOGOUT DROPDOWN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script>
    function toggleDropdown() {
        const dropdown = document.getElementById("dropdownMenu");
        dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
    }

    // Close dropdown when clicking outside
    document.addEventListener("click", function (e) {
        const dropdown = document.getElementById("dropdownMenu");
        if (!e.target.closest("nav")) {
        dropdown.style.display = "none";
        }
    });
</script>

</body>
</html>
